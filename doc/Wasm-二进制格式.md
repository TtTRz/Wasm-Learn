# WASM-二进制格式



## Wasm二进制模块可能包含的 12 种段

### 类型段（ID 是 1）

* 具有函数签名

### 导入段和导出段（ID 是2、7）

* 模块的导出和导入
* 比如 函数、全局变量

### 函数段和代码段（ID 是 3、10）

* 用来存内部函数信息
* 函数段是一个索引表，列出内部函数所对应的函数签名
* 代码段存储内部函数的局部变量信息和字节码
* 函数和代码段中的项目数量必须一致，一一对应

### 表段和元素段（ID 是 4、9）

* 表段列出模块内定义的所有表
* 元素段列出表初始化数据
* WASM 规范规定模块最多只能导入或定义一张表

### 内存段和数据段（ID 是 5、10）

* 内存段列出模块内定义的所有内存
* 数据段列出内存初始化数据
* WASM 规范规定模块最多只能导入或定义一块内存

### 全局段（ID 是 6）

* 列出模块内定义的所有全局变量信息
* 包括值类型、可变性和初始值

### 起始段（ID 是 8）

* 给出模块的起始函数索引
* 两个作用：
  * 在模块加载后进行一些初始化工作
  * 把模块变成可执行程序
* 如果模块有起始段，Wasm 实现在加载模块后会自动执行起始函数

### 自定义段（ID 是 0）

* 给编译器等工具使用
* 可以存放函数名等调试信息或其他任何附加信息
* 自定义段不参与 Wasm 语义
* 即使完全忽略也不影响模块的执行



**除了自定义段，其他段必须按 ID 递增的顺序出现。**

原因：因为很多段之间存在信息的依赖关系。

由于导入段、函数段、代码段等都需要知道函数类型信息，所以类型段必须在这 3 个段之前出现。

由于导入的函数、表、内存、全局变量在各自索引空间的最前面，所以导入段必须在这 4 个段之前出现。

由于导出函数、表、内存、全局变量时需要知道其索引，所以导出段必须在这 4 个段之后出现。



**Wasm 二进制格式的设计原则之一是可以一遍（One-pass）完成模块的解析、验证和编译（AOT 或 JIT 编译）。**

**Wasm 实现可以在下载模块的同时进行解码、验证和编译。**

**可流式处理（Streamable）是 Wasm 的特点之一，二进制模块中各个段的排列方式一定程度上是为了满足这一特点。**

